@model DTOs.Camera.CameraConfigurationViewModel
@{
    ViewData["Title"] = "Camera Configuration";
    var camera = ViewBag.Camera as DTOs.Camera.CameraViewModel;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-action="Index">مدیریت دوربین‌ها</a></li>
                        <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@camera?.Id">@camera?.Name</a></li>
                        <li class="breadcrumb-item active">تنظیمات</li>
                    </ol>
                </nav>
                <h1 class="h3 mb-0">تنظیمات دوربین: @camera?.Name</h1>
            </div>

            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @ViewBag.Error
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <form asp-action="Configuration" asp-route-id="@camera?.Id" method="post">
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.Id)

                <div class="row">
                    <!-- Video Settings -->
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-video text-primary me-2"></i>
                                    تنظیمات ویدئو
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="Resolution" class="form-label">رزولوشن <span class="text-danger">*</span></label>
                                    <select asp-for="Resolution" class="form-select">
                                        <option value="640x480">VGA (640x480)</option>
                                        <option value="1280x720">HD (1280x720)</option>
                                        <option value="1920x1080">Full HD (1920x1080)</option>
                                        <option value="2560x1440">QHD (2560x1440)</option>
                                        <option value="3840x2160">4K (3840x2160)</option>
                                    </select>
                                    <span asp-validation-for="Resolution" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="FrameRate" class="form-label">نرخ فریم (FPS) <span class="text-danger">*</span></label>
                                    <select asp-for="FrameRate" class="form-select">
                                        <option value="10">10 FPS</option>
                                        <option value="15">15 FPS</option>
                                        <option value="20">20 FPS</option>
                                        <option value="25">25 FPS</option>
                                        <option value="30">30 FPS</option>
                                        <option value="60">60 FPS</option>
                                    </select>
                                    <span asp-validation-for="FrameRate" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="VideoCodec" class="form-label">کدک ویدئو <span class="text-danger">*</span></label>
                                    <select asp-for="VideoCodec" class="form-select">
                                        <option value="H264">H.264</option>
                                        <option value="H265">H.265 (HEVC)</option>
                                        <option value="MJPEG">MJPEG</option>
                                    </select>
                                    <span asp-validation-for="VideoCodec" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Bitrate" class="form-label">نرخ بیت (Kbps) <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input asp-for="Bitrate" class="form-control" type="number" min="100" max="50000" />
                                        <span class="input-group-text">Kbps</span>
                                    </div>
                                    <div class="form-text">
                                        پیشنهاد: 1024-2048 برای HD، 2048-4096 برای Full HD
                                    </div>
                                    <span asp-validation-for="Bitrate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Settings -->
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-volume-up text-success me-2"></i>
                                    تنظیمات صدا
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="AudioEnabled" class="form-check-input" type="checkbox" id="audioEnabledSwitch">
                                        <label class="form-check-label" for="audioEnabledSwitch">
                                            فعال‌سازی صدا
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3" id="audioCodecGroup">
                                    <label asp-for="AudioCodec" class="form-label">کدک صدا</label>
                                    <select asp-for="AudioCodec" class="form-select">
                                        <option value="">انتخاب کنید</option>
                                        <option value="AAC">AAC</option>
                                        <option value="MP3">MP3</option>
                                        <option value="PCM">PCM</option>
                                    </select>
                                    <span asp-validation-for="AudioCodec" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Motion Detection Settings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-running text-warning me-2"></i>
                                    تشخیص حرکت
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="MotionDetectionEnabled" class="form-check-input" type="checkbox" id="motionDetectionSwitch">
                                        <label class="form-check-label" for="motionDetectionSwitch">
                                            فعال‌سازی تشخیص حرکت
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3" id="motionSensitivityGroup">
                                    <label asp-for="MotionSensitivity" class="form-label">حساسیت تشخیص</label>
                                    <div class="range-container">
                                        <input asp-for="MotionSensitivity" type="range" class="form-range" min="1" max="100" id="sensitivityRange">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>کم (1)</span>
                                            <span id="sensitivityValue">@Model.MotionSensitivity</span>
                                            <span>زیاد (100)</span>
                                        </div>
                                    </div>
                                    <span asp-validation-for="MotionSensitivity" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Recording Settings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-record-vinyl text-danger me-2"></i>
                                    تنظیمات ضبط
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="RecordingEnabled" class="form-check-input" type="checkbox" id="recordingEnabledSwitch">
                                        <label class="form-check-label" for="recordingEnabledSwitch">
                                            فعال‌سازی ضبط
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a asp-action="Details" asp-route-id="@camera?.Id" class="btn btn-secondary">
                                            <i class="fas fa-arrow-left me-2"></i>
                                            بازگشت
                                        </a>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-info me-2" onclick="resetToDefault()">
                                            <i class="fas fa-undo me-2"></i>
                                            بازگردانی به حالت پیش‌فرض
                                        </button>
                                        <button type="button" class="btn btn-outline-warning me-2" onclick="testConfiguration()">
                                            <i class="fas fa-vial me-2"></i>
                                            تست تنظیمات
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>
                                            ذخیره تنظیمات
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Audio settings toggle
            const audioEnabled = document.getElementById('audioEnabledSwitch');
            const audioCodecGroup = document.getElementById('audioCodecGroup');
            
            function toggleAudioSettings() {
                if (audioEnabled.checked) {
                    audioCodecGroup.style.display = 'block';
                } else {
                    audioCodecGroup.style.display = 'none';
                }
            }
            
            audioEnabled.addEventListener('change', toggleAudioSettings);
            toggleAudioSettings(); // Initial state

            // Motion detection toggle
            const motionDetection = document.getElementById('motionDetectionSwitch');
            const motionSensitivityGroup = document.getElementById('motionSensitivityGroup');
            
            function toggleMotionSettings() {
                if (motionDetection.checked) {
                    motionSensitivityGroup.style.display = 'block';
                } else {
                    motionSensitivityGroup.style.display = 'none';
                }
            }
            
            motionDetection.addEventListener('change', toggleMotionSettings);
            toggleMotionSettings(); // Initial state

            // Sensitivity range slider
            const sensitivityRange = document.getElementById('sensitivityRange');
            const sensitivityValue = document.getElementById('sensitivityValue');
            
            sensitivityRange.addEventListener('input', function() {
                sensitivityValue.textContent = this.value;
            });

            // Auto-adjust bitrate based on resolution
            const resolution = document.querySelector('select[name="Resolution"]');
            const bitrate = document.querySelector('input[name="Bitrate"]');
            
            resolution.addEventListener('change', function() {
                switch(this.value) {
                    case '640x480':
                        bitrate.value = 512;
                        break;
                    case '1280x720':
                        bitrate.value = 1024;
                        break;
                    case '1920x1080':
                        bitrate.value = 2048;
                        break;
                    case '2560x1440':
                        bitrate.value = 4096;
                        break;
                    case '3840x2160':
                        bitrate.value = 8192;
                        break;
                }
            });
        });

        function resetToDefault() {
            if (confirm('آیا از بازگردانی تنظیمات به حالت پیش‌فرض اطمینان دارید؟')) {
                // Reset to default values
                document.querySelector('select[name="Resolution"]').value = '1920x1080';
                document.querySelector('select[name="FrameRate"]').value = '25';
                document.querySelector('select[name="VideoCodec"]').value = 'H264';
                document.querySelector('input[name="Bitrate"]').value = '2048';
                document.querySelector('input[name="AudioEnabled"]').checked = false;
                document.querySelector('select[name="AudioCodec"]').value = '';
                document.querySelector('input[name="MotionDetectionEnabled"]').checked = true;
                document.querySelector('input[name="MotionSensitivity"]').value = '75';
                document.querySelector('input[name="RecordingEnabled"]').checked = false;
                
                // Trigger change events
                document.querySelector('input[name="AudioEnabled"]').dispatchEvent(new Event('change'));
                document.querySelector('input[name="MotionDetectionEnabled"]').dispatchEvent(new Event('change'));
                document.querySelector('input[name="MotionSensitivity"]').dispatchEvent(new Event('input'));
            }
        }

        function testConfiguration() {
            // TODO: Implement configuration testing
            alert('در حال تست تنظیمات...\nقابلیت تست تنظیمات به زودی اضافه خواهد شد');
        }
    </script>
}
