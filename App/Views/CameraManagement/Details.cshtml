@model DTOs.Camera.CameraViewModel
@{
    ViewData["Title"] = "Camera Details";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-action="Index">مدیریت دوربین‌ها</a></li>
                        <li class="breadcrumb-item active">جزئیات دوربین</li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">@Model.Name</h1>
                    <div class="btn-group" role="group">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>ویرایش
                        </a>
                        <a asp-action="Configuration" asp-route-id="@Model.Id" class="btn btn-outline-info">
                            <i class="fas fa-cog me-2"></i>تنظیمات
                        </a>
                        @if (Model.Status == Domain.Aggregates.Camera.CameraStatus.Active)
                        {
                            <form asp-action="Disconnect" asp-route-id="@Model.Id" method="post" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-outline-warning">
                                    <i class="fas fa-stop me-2"></i>قطع اتصال
                                </button>
                            </form>
                        }
                        else
                        {
                            <form asp-action="Connect" asp-route-id="@Model.Id" method="post" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-outline-success">
                                    <i class="fas fa-play me-2"></i>اتصال
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <div class="row">
                <!-- Camera Info Card -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">اطلاعات دوربین</h5>
                            <div class="camera-status">
                                @switch (Model.Status)
                                {
                                    case Domain.Aggregates.Camera.CameraStatus.Active:
                                        <span class="badge bg-success fs-6">
                                            <i class="fas fa-circle me-1"></i>فعال
                                        </span>
                                        break;
                                    case Domain.Aggregates.Camera.CameraStatus.Inactive:
                                        <span class="badge bg-secondary fs-6">
                                            <i class="fas fa-circle me-1"></i>غیرفعال
                                        </span>
                                        break;
                                    case Domain.Aggregates.Camera.CameraStatus.Error:
                                        <span class="badge bg-danger fs-6">
                                            <i class="fas fa-exclamation-triangle me-1"></i>خطا
                                        </span>
                                        break;
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item mb-3">
                                        <label class="text-muted small">نام دوربین</label>
                                        <div class="fw-bold">@Model.Name</div>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="text-muted small">موقعیت</label>
                                        <div class="fw-bold">
                                            @Model.Location
                                            @if (!string.IsNullOrEmpty(Model.LocationZone))
                                            {
                                                <br><small class="text-info">@Model.LocationZone</small>
                                            }
                                        </div>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="text-muted small">نوع دوربین</label>
                                        <div>
                                            <span class="badge bg-info">@Model.Type</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item mb-3">
                                        <label class="text-muted small">آدرس شبکه</label>
                                        <div class="fw-bold">
                                            <code>@Model.IpAddress:@Model.Port</code>
                                        </div>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="text-muted small">تاریخ ایجاد</label>
                                        <div class="fw-bold">@Model.CreatedAt.ToString("yyyy/MM/dd HH:mm")</div>
                                    </div>
                                    <div class="info-item mb-3">
                                        <label class="text-muted small">آخرین فعالیت</label>
                                        <div class="fw-bold">
                                            @if (Model.LastActiveAt.HasValue)
                                            {
                                                @Model.LastActiveAt.Value.ToString("yyyy/MM/dd HH:mm:ss")
                                            }
                                            else
                                            {
                                                <span class="text-muted">هرگز</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Stream Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">نمایش زنده</h5>
                        </div>
                        <div class="card-body">
                            @if (Model.Status == Domain.Aggregates.Camera.CameraStatus.Active)
                            {
                                <div class="stream-container text-center">
                                    <div class="stream-placeholder bg-dark d-flex align-items-center justify-content-center" style="height: 400px; border-radius: 8px;">
                                        <div class="text-white">
                                            <i class="fas fa-video fa-3x mb-3"></i>
                                            <h5>نمایش زنده دوربین</h5>
                                            <p class="mb-3">برای مشاهده تصویر زنده، روی دکمه پخش کلیک کنید</p>
                                            <button class="btn btn-primary" onclick="startLiveStream()">
                                                <i class="fas fa-play me-2"></i>شروع پخش زنده
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="fas fa-video-slash fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">دوربین آفلاین است</h5>
                                    <p class="text-muted">برای مشاهده تصویر زنده، ابتدا دوربین را وصل کنید</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Stats -->
                <div class="col-lg-4">
                    <!-- Connection Status Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">وضعیت اتصال</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="status-indicator me-3">
                                    @if (Model.IsOnline)
                                    {
                                        <div class="bg-success rounded-circle" style="width: 12px; height: 12px;"></div>
                                    }
                                    else
                                    {
                                        <div class="bg-danger rounded-circle" style="width: 12px; height: 12px;"></div>
                                    }
                                </div>
                                <div>
                                    <div class="fw-bold">
                                        @(Model.IsOnline ? "آنلاین" : "آفلاین")
                                    </div>
                                    <small class="text-muted">
                                        @if (Model.LastActiveAt.HasValue)
                                        {
                                            @GetRelativeTime(Model.LastActiveAt.Value)
                                        }
                                        else
                                        {
                                            @:هیچ فعالیتی ثبت نشده
                                        }
                                    </small>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-info btn-sm" onclick="pingCamera()">
                                    <i class="fas fa-wifi me-2"></i>تست اتصال
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshStatus()">
                                    <i class="fas fa-sync-alt me-2"></i>بروزرسانی وضعیت
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">عملیات سریع</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a asp-action="Configuration" asp-route-id="@Model.Id" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-cog me-2"></i>تنظیمات دوربین
                                </a>
                                <button class="btn btn-outline-info btn-sm" onclick="takeSnapshot()">
                                    <i class="fas fa-camera me-2"></i>گرفتن عکس
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="startRecording()">
                                    <i class="fas fa-record-vinyl me-2"></i>شروع ضبط
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="viewLogs()">
                                    <i class="fas fa-list me-2"></i>مشاهده لاگ‌ها
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Statistics -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">آمار دوربین</h6>
                        </div>
                        <div class="card-body">
                            <div class="stat-item d-flex justify-content-between mb-2">
                                <span class="text-muted">زمان آپتایم:</span>
                                <span class="fw-bold" id="uptime">محاسبه در حال انجام...</span>
                            </div>
                            <div class="stat-item d-flex justify-content-between mb-2">
                                <span class="text-muted">تعداد قطعی:</span>
                                <span class="fw-bold">-</span>
                            </div>
                            <div class="stat-item d-flex justify-content-between mb-2">
                                <span class="text-muted">آخرین خطا:</span>
                                <span class="fw-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function startLiveStream() {
            // TODO: Implement live stream functionality
            alert('قابلیت پخش زنده به زودی اضافه خواهد شد');
        }

        function pingCamera() {
            // TODO: Implement ping functionality
            alert('در حال تست اتصال...');
        }

        function refreshStatus() {
            window.location.reload();
        }

        function takeSnapshot() {
            // TODO: Implement snapshot functionality
            alert('قابلیت گرفتن عکس به زودی اضافه خواهد شد');
        }

        function startRecording() {
            // TODO: Implement recording functionality
            alert('قابلیت ضبط به زودی اضافه خواهد شد');
        }

        function viewLogs() {
            // TODO: Implement logs functionality
            alert('قابلیت مشاهده لاگ‌ها به زودی اضافه خواهد شد');
        }

        // Calculate and display uptime
        function calculateUptime() {
            const createdAt = new Date('@Model.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")');
            const now = new Date();
            const diffMs = now - createdAt;
            
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            let uptime = '';
            if (days > 0) uptime += days + ' روز ';
            if (hours > 0) uptime += hours + ' ساعت ';
            if (minutes > 0) uptime += minutes + ' دقیقه';
            
            document.getElementById('uptime').textContent = uptime || 'کمتر از یک دقیقه';
        }

        // Auto refresh status every 30 seconds
        setInterval(function() {
            // Update uptime
            calculateUptime();
        }, 1000);

        // Initial calculation
        calculateUptime();
    </script>
}

@functions {
    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        if (timeSpan.TotalMinutes < 1)
            return "همین الان";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} دقیقه پیش";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} ساعت پیش";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} روز پیش";
        
        return dateTime.ToString("yyyy/MM/dd");
    }
}
